name: lvs-dr
mgmt:
  ipv6-subnet: ""
  ipv4-subnet: 172.20.20.0/24

topology:
  nodes:
    brl4lb:
      kind: bridge

    router:
      kind: linux
      image: 192.168.2.100:5000/xcni
      exec:
      - ip a a 10.1.5.1/24 dev net1
      - ip a a 10.1.8.1/24 dev net2
      - sh -c 'bash -c "echo 1 > /proc/sys/net/ipv4/ip_forward"'

    lvs-dr-lb:
      kind: linux
      image: 192.168.2.100:5000/xcni
      exec:
        - >
          bash -c '
          ip a a 10.1.8.253/24 dev net1 &&
          ip a a 10.1.8.254/32 dev lo &&
          ip r r default via 10.1.8.1 dev net1 &&
          bash -c "echo 1 > /proc/sys/net/ipv4/ip_forward" &&
          ipvsadm -A -t 10.1.8.254:80 -s rr &&
          ipvsadm -a -t 10.1.8.254:80 -r 10.1.8.10:80 -g &&
          ipvsadm -a -t 10.1.8.254:80 -r 10.1.8.11:80 -g &&
          ipvsadm -a -t 10.1.8.254:80 -r 10.1.8.12:80 -g &&
          ipvsadm-save'

    dr-rs1:
      kind: linux
      image: 192.168.2.100:5000/nettool
      exec:
      - ip a a 10.1.8.10/24 dev net1
      - ip a a 10.1.8.254/32 dev lo
      - ip r r default via 10.1.8.1 dev net1
      - >
        sh -c '
        bash -c "echo 1 > /proc/sys/net/ipv4/conf/all/arp_ignore" && bash -c "echo 2 > /proc/sys/net/ipv4/conf/all/arp_announce" &&
        bash -c "echo 1 > /proc/sys/net/ipv4/conf/lo/arp_ignore" && bash -c "echo 2 > /proc/sys/net/ipv4/conf/lo/arp_announce"'
          

    dr-rs2:
      kind: linux
      image: 192.168.2.100:5000/nettool
      exec:
      - ip a a 10.1.8.11/24 dev net1
      - ip a a 10.1.8.254/32 dev lo
      - ip r r default via 10.1.8.1 dev net1
      - >
        sh -c '
        bash -c "echo 1 > /proc/sys/net/ipv4/conf/all/arp_ignore" && bash -c "echo 2 > /proc/sys/net/ipv4/conf/all/arp_announce" &&
        bash -c "echo 1 > /proc/sys/net/ipv4/conf/lo/arp_ignore" && bash -c "echo 2 > /proc/sys/net/ipv4/conf/lo/arp_announce"'


    dr-rs3:
      kind: linux
      image: 192.168.2.100:5000/nettool
      exec:
      - ip a a 10.1.8.12/24 dev net1
      - ip a a 10.1.8.254/32 dev lo
      - ip r r default via 10.1.8.1 dev net1
      - >
        sh -c '
        bash -c "echo 1 > /proc/sys/net/ipv4/conf/all/arp_ignore" && bash -c "echo 2 > /proc/sys/net/ipv4/conf/all/arp_announce" &&
        bash -c "echo 1 > /proc/sys/net/ipv4/conf/lo/arp_ignore" && bash -c "echo 2 > /proc/sys/net/ipv4/conf/lo/arp_announce"'

    client:
      kind: linux
      image: 192.168.2.100:5000/nettool
      exec:
      - ip addr add 10.1.5.5/24 dev net1
      - ip r r default via 10.1.5.1
      - bash -c 'echo "10.1.5.1 www.wluo.com" >> /etc/hosts'

  links:
    - endpoints: ["router:net2", "brl4lb:net1"]
    - endpoints: ["lvs-dr-lb:net1", "brl4lb:net2"]
    - endpoints: ["dr-rs1:net1", "brl4lb:net3"]
    - endpoints: ["dr-rs2:net1", "brl4lb:net4"]
    - endpoints: ["dr-rs3:net1", "brl4lb:net5"]
    - endpoints: ["client:net1", "router:net1"]
